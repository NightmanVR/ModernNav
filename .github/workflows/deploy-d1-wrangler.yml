name: Deploy to Cloudflare Pages
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm ci

      - name: Setup Wrangler & API tools
        run: npm install -g wrangler

      - name: Setup & Configure D1 Database
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          # Optional: Users can set these Secrets to use existing D1 database
          D1_DATABASE_NAME: ${{ secrets.D1_DATABASE_NAME }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
        run: |
          set -e
          ACCOUNT_ID="${CF_ACCOUNT_ID}"
          API_TOKEN="${CF_API_TOKEN}"
          # Use provided D1_DATABASE_NAME or default to 'modern-nav-db'
          DB_NAME="${D1_DATABASE_NAME:-modern-nav-db}"
          PROVIDED_DB_ID="${D1_DATABASE_ID}"

          IS_NEW_DATABASE=false

          if [ -n "$PROVIDED_DB_ID" ] && [ "$PROVIDED_DB_ID" != "null" ]; then
            # User provided DATABASE_ID via Secret - use it directly
            echo "=== Using provided DATABASE_ID from Secret ==="
            DB_ID="$PROVIDED_DB_ID"
            echo "Using D1 database: name='$DB_NAME', id='$DB_ID'"
            echo "âš ï¸  Skipping schema initialization for existing database (data protection)"
          else
            # Auto-detect or create database
            echo "=== Detecting D1 database: '$DB_NAME' ==="
            DB_ID=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/d1/database" \
              -H "Authorization: Bearer ${API_TOKEN}" | \
              jq -r ".result[] | select(.name==\"${DB_NAME}\") | .id" | head -1)
            
            if [ -z "$DB_ID" ] || [ "$DB_ID" = "null" ]; then
              echo "Database not found. Creating '$DB_NAME'..."
              DB_ID=$(curl -s -X POST "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/d1/database" \
                -H "Authorization: Bearer ${API_TOKEN}" \
                -H "Content-Type: application/json" \
                -d "{\"name\": \"${DB_NAME}\"}" | jq -r '.result.id')
              
              if [ -z "$DB_ID" ] || [ "$DB_ID" = "null" ]; then
                echo "Failed to create D1 database"
                exit 1
              fi
              echo "âœ“ Created D1 database: $DB_ID"
              IS_NEW_DATABASE=true
              sleep 3
            else
              echo "âœ“ Found existing D1 database: $DB_ID"
              echo "âš ï¸  This is an existing database - schema initialization will be skipped to protect existing data"
            fi
          fi

          echo "=== Generating wrangler.toml ==="
          sed "s|{{DATABASE_ID}}|${DB_ID}|g" wrangler.toml.template > wrangler.toml
          echo "âœ“ wrangler.toml generated with database_id=$DB_ID"

          echo "=== Initializing database schema ==="
          if [ "$IS_NEW_DATABASE" = true ] && [ -z "$PROVIDED_DB_ID" ]; then
            echo "New database detected. Executing schema initialization..."
            npx wrangler d1 execute "${DB_NAME}" --file schema.sql --remote 2>/dev/null || echo "Schema initialization completed"
            echo "âœ“ Schema initialization completed"
          else
            echo "Skipping schema initialization (existing database detected)"
            echo "ðŸ’¡ Tip: If you need to add new tables, manually execute schema.sql in Cloudflare Console"
          fi

      - name: Build frontend
        run: npm run build

      - name: Publish to Cloudflare Pages
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          npx wrangler publish
